前章ではタイトルを付け、ゲームの「開始」と「終了」を明確にしました。
次は、ゲームを面白くする要素として「HP（ヒットポイント）」と「弾の攻撃力」そして「エネミーがダメージを受けた時のアニメーション」「プレイヤーの無敵アニメーション」を実装します。

<span id="h11-1"></span>11.1　HP（ヒットポイント）と攻撃力（power）の実装
-------------------------------------------------------------------------

まずは**Enemy.cs**にヒットポイントを実装します。

<div class="source-code">

Enemy.cs

``` {.source}
using UnityEngine;
using System.Collections;

public class Enemy : MonoBehaviour
{
        // ヒットポイント
        public int hp = 1;

        // Spaceshipコンポーネント
        Spaceship spaceship;

        IEnumerator Start ()
        {

                // Spaceshipコンポーネントを取得
                spaceship = GetComponent<Spaceship> ();

                // ローカル座標のY軸のマイナス方向に移動する
                Move (transform.up * -1);

                // canShotがfalseの場合、ここでコルーチンを終了させる
                if (spaceship.canShot == false) {
                        yield break;
                }

                while (true) {

                        // 子要素を全て取得する
                        for (int i = 0; i < transform.childCount; i++) {

                                Transform shotPosition = transform.GetChild (i);

                                // ShotPositionの位置/角度で弾を撃つ
                                spaceship.Shot (shotPosition);
                        }

                        // shotDelay秒待つ
                        yield return new WaitForSeconds (spaceship.shotDelay);
                }
        }

        // 機体の移動
        public void Move (Vector2 direction)
        {
                rigidbody2D.velocity = direction * spaceship.speed;
        }

        void OnTriggerEnter2D (Collider2D c)
        {
                // レイヤー名を取得
                string layerName = LayerMask.LayerToName (c.gameObject.layer);

                // レイヤー名がBullet (Player)以外の時は何も行わない
                if (layerName != "Bullet (Player)") return;

                // 弾の削除
                Destroy(c.gameObject);

                // 爆発
                spaceship.Explosion ();

                // エネミーの削除
                Destroy (gameObject);
        }
}
```

</div>

次に**Bullet.cs**に攻撃力を実装します。

<div class="source-code">

Bullet.cs

``` {.source}
using UnityEngine;

public class Bullet : MonoBehaviour
{
        // 弾の移動スピード
        public int speed = 10;

        // ゲームオブジェクト生成から削除するまでの時間
        public float lifeTime = 1;

        // 攻撃力
        public int power = 1;

        void Start ()
        {
                // ローカル座標のY軸方向に移動する
                rigidbody2D.velocity = transform.up.normalized * speed;

                // lifeTime秒後に削除
                Destroy (gameObject, lifeTime);
        }
}
```

</div>

### <span id="h11-1-1"></span>ヒットポイントが0になった時に爆発させる

**Enemy.cs**のOnTriggerEnter2Dメソッド内にヒットポイントを減らしていく処理を実装していきます。
今回はたまの攻撃力の数値でヒットポイントを減らしていきます。

<div class="source-code">

Enemy.cs

``` {.source}
using UnityEngine;
using System.Collections;

public class Enemy : MonoBehaviour
{
        // ヒットポイント
        public int hp = 1;

        // Spaceshipコンポーネント
        Spaceship spaceship;

        IEnumerator Start ()
        {

                // Spaceshipコンポーネントを取得
                spaceship = GetComponent<Spaceship> ();

                // ローカル座標のY軸のマイナス方向に移動する
                Move (transform.up * -1);

                // canShotがfalseの場合、ここでコルーチンを終了させる
                if (spaceship.canShot == false) {
                        yield break;
                }

                while (true) {

                        // 子要素を全て取得する
                        for (int i = 0; i < transform.childCount; i++) {

                                Transform shotPosition = transform.GetChild (i);

                                // ShotPositionの位置/角度で弾を撃つ
                                spaceship.Shot (shotPosition);
                        }

                        // shotDelay秒待つ
                        yield return new WaitForSeconds (spaceship.shotDelay);
                }
        }

        // 機体の移動
        public void Move (Vector2 direction)
        {
                rigidbody2D.velocity = direction * spaceship.speed;
        }

        void OnTriggerEnter2D (Collider2D c)
        {
                // レイヤー名を取得
                string layerName = LayerMask.LayerToName (c.gameObject.layer);

                // レイヤー名がBullet (Player)以外の時は何も行わない
                if (layerName != "Bullet (Player)") return;

                // PlayerBulletのTransformを取得
                Transform playerBulletTransform = c.transform.parent;

                // Bulletコンポーネントを取得
                Bullet bullet =  playerBulletTransform.GetComponent<Bullet>();

                // ヒットポイントを減らす
                hp = hp - bullet.power;

                // 弾の削除
                Destroy(c.gameObject);

                // ヒットポイントが0以下であれば
                if(hp <= 0 )
                {
                        // 爆発
                        spaceship.Explosion ();

                        // エネミーの削除
                        Destroy (gameObject);
                }
        }
}
```

</div>

**Waveプレハブ**のEnemyを3つ選択し、HPの値を**10**にします。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/enemy_hitpoint.png)

</div>

ゲームを再生してみましょう。プレイヤーの弾に何発か当たらないとエネミーは爆発しなくなります。

<span id="h11-2"></span>11.2　ダメージを受けた時の表現
------------------------------------------------------

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/damage_enemy.png)

</div>

エネミーがダメージを受けたときに、わかりやすく機体の色を赤色にします。

### <span id="h11-2-1"></span>アニメーター - レイヤーの作成

<div class="image">

![新しいレイヤーを作成し、ダメージを受けた時の表現を実装する（完成図）](wp-content/uploads/2d-shooting-game/game/images/11/animator_layer.png)
図11.1:
新しいレイヤーを作成し、ダメージを受けた時の表現を実装する（完成図）

</div>

エネミーには既に**Normal**という「スプライトを切り替えていく」アニメーションがあります。今回はそのNormalアニメーションに、色を変化させるアニメーションを「上書き」する形でダメージを表現します。

#### <span id="h11-2-1-1"></span>レイヤーの追加

レイヤーを追加します。追加した後は、「**NameをDamage
Layer**、**Weightを1**にしてください。

<div style="display:flex">

<div class="image">

![レイヤーの追加](wp-content/uploads/2d-shooting-game/game/images/11/add_animator_layer.png)
図11.2: レイヤーの追加

</div>

<div class="image">

![レイヤー名とウェイトの変更](wp-content/uploads/2d-shooting-game/game/images/11/rename_layername_and_change_weight.png)
図11.3: レイヤー名とウェイトの変更

</div>

</div>

図11.3にBlendingという項目があり、これが**Override**で**Weightが1**であれば「他のレイヤーで同じ色のアニメーションをしている場合でも、Damage
Layerの色のアニメーションを使用する」事になります。

#### <span id="h11-2-1-2"></span>Damageアニメーションの作成

**Enemy**フォルダ上で右クリックし、`Create → Animation`{.inline-code}を選択してアニメーションのアセットを作成します。名前は**Damage**としてください。

<div class="image">

![フォルダを右クリックしてメニューを選択するとフォルダ下に作成される](wp-content/uploads/2d-shooting-game/game/images/11/create_damage_animation.png)
図11.4:
フォルダを右クリックしてメニューを選択するとフォルダ下に作成される

</div>

作成したらアニメーターに登録するためにDamageアニメーションをアニメーターの**Damage
Layer**上にドラッグ＆ドロップします。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/drag_damage_animation.png)

</div>

次はアニメーションを作成していきます。一度**Enemyのプレハブ**をシーン上へドラッグ＆ドロップしてください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/drop_enemy.png)

</div>

**Enemy**ゲームオブジェクトを選択しながら、**Window →
Animation**を選択し、Animationウィンドウを開きます。
開いたらNormalアニメーションが選択されているので、Damageアニメーションへ変更します。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/select_damage_animation.png)

</div>

アニメーションを行うプロパティを登録します。`Add Curve`{.inline-code}ボタンで**Sprite
Renderer → Color**を追加してください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/add_sprite_color_curve.png)

</div>

するとデフォルトでKeyが2箇所、設定されているので右側のKeyを削除します。Keyを右クリックして**Delete
Keys**を選択してください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/delete_key.png)

</div>

更に２つの操作を行います。
まずは、0フレーム目にあるKeyを5フレーム目に移動させます。一番上のKeyをドラッグして5フレームまで移動させてください。フレーム数の確認は左上で確認することが出来ます。
次に色の情報を変更します。**Color.rを1**、**Color.gを0**、**Color.bを0.6**、**Color.aを1**にしてください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/move_key_and_change_color_property.png)

</div>

インスペクターのプレビューでエネミーが赤色になっているはずです。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/pprite_preview.png)

</div>

#### <span id="h11-2-1-3"></span>トリガーの作成

ダメージを受けた時のみエネミーを赤色にするため、**トリガー**という機能を使います。
まずアニメーター上で**空のステート**を作成します。アニメーターウィンドウ上で右クリックをして、`Create State → Empty`{.inline-code}を選択してください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/create_state_empty.png)

</div>

名前を**Dummy**とします。ステートの名前を変更するにはインスペクター上で行います。ステートをクリックしてインスペクターを表示させましょう。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/rename_dummy_state.png)

</div>

次にDummyをデフォルトステートとします。Dummyステート上で右クリックして`Set As Default`{.inline-code}を選択してください。デフォルトステートはゲーム再生直後に再生されるステートのことを指します。こうすることによって、ゲーム再生時、Damage
LayerではDummyステートが再生され、**何もアニメーションを行わない**状態になります。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/set_as_default.png)

</div>

次は何も行わない状態からトリガーによって**Damageアニメーションを再生 →
何も行わない状態 →
Damageアニメーション...**と繰り返し状態の遷移を行うようにします。
Dummy上で右クリックし、**Make Transition**を選択します。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/make_transition.png)

</div>

カーソルに矢印が追従するのでDamageステート上でクリックします。そうするとDummyステートからDamageステートへ**何らかの条件で遷移する**事ができるようになります。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/assign_transition_1.png)

</div>

同じようにDamageステートからDummyステートへのTransitionも作成しましょう。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/assign_transition_2.png)

</div>

次にトリガーを作成します。アニメーターウィンドウの左下にあるParametersの＋ボタンを押して**Trigger**を選択してください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/create_trigger.png)

</div>

名前を**Damage**とします。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/rename_damage_trigger.png)

</div>

DummyステートからDamageステートへのTransitionをクリックし、表示されたインスペクターのConditionsをDamageへと変更します。DamageステートからDummyステートへのTransitionはそのままにしておきましょう。

<div style="display:flex">

<div class="image">

![ConditionsをDamageへ](wp-content/uploads/2d-shooting-game/game/images/11/set_damage_trigger.png)
図11.5: ConditionsをDamageへ

</div>

<div class="image">

![そのまま変更なし](wp-content/uploads/2d-shooting-game/game/images/11/damage_dummy_transition.png)
図11.6: そのまま変更なし

</div>

</div>

### <span id="h11-2-2"></span>スクリプトからトリガーのセット

ダメージを受けた時に「トリガーをセット」してダメージアニメーションを再生させます。
まずは**Spaceship.cs**にAnimatorコンポーネントを取得するメソッドを追加します。

<div class="source-code">

Spaceship.cs

``` {.source}
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D), typeof(Animator))]
public class Spaceship : MonoBehaviour
{
        // 移動スピード
        public float speed;

        // 弾を撃つ間隔
        public float shotDelay;

        // 弾のPrefab
        public GameObject bullet;

        // 弾を撃つかどうか
        public bool canShot;

        // 爆発のPrefab
        public GameObject explosion;

        // アニメーターコンポーネント
        private Animator animator;

        void Start ()
        {
                // アニメーターコンポーネントを取得
                animator = GetComponent<Animator> ();
        }

        // 爆発の作成
        public void Explosion ()
        {
                Instantiate (explosion, transform.position, transform.rotation);
        }

        // 弾の作成
        public void Shot (Transform origin)
        {
                Instantiate (bullet, origin.position, origin.rotation);
        }

        // アニメーターコンポーネントの取得
        public Animator GetAnimator()
        {
                return animator;
        }
}
```

</div>

OnTriggerEnter2Dメソッド内にある、エネミーのHPをチェックしている部分を「HPが0以上であればDamageトリガーをセットする」ようにします。

<div class="source-code">

Enemy.cs

``` {.source}
using UnityEngine;
using System.Collections;

public class Enemy : MonoBehaviour
{
        // ヒットポイント
        public int hp = 1;

        // Spaceshipコンポーネント
        Spaceship spaceship;

        IEnumerator Start ()
        {

                // Spaceshipコンポーネントを取得
                spaceship = GetComponent<Spaceship> ();

                // ローカル座標のY軸のマイナス方向に移動する
                Move (transform.up * -1);

                // canShotがfalseの場合、ここでコルーチンを終了させる
                if (spaceship.canShot == false) {
                        yield break;
                }

                while (true) {

                        // 子要素を全て取得する
                        for (int i = 0; i < transform.childCount; i++) {

                                Transform shotPosition = transform.GetChild (i);

                                // ShotPositionの位置/角度で弾を撃つ
                                spaceship.Shot (shotPosition);
                        }

                        // shotDelay秒待つ
                        yield return new WaitForSeconds (spaceship.shotDelay);
                }
        }

        // 機体の移動
        public void Move (Vector2 direction)
        {
                rigidbody2D.velocity = direction * spaceship.speed;
        }

        void OnTriggerEnter2D (Collider2D c)
        {
                // レイヤー名を取得
                string layerName = LayerMask.LayerToName (c.gameObject.layer);

                // レイヤー名がBullet (Player)以外の時は何も行わない
                if (layerName != "Bullet (Player)") return;

                // PlayerBulletのTransformを取得
                Transform playerBulletTransform = c.transform.parent;

                // Bulletコンポーネントを取得
                Bullet bullet =  playerBulletTransform.GetComponent<Bullet>();

                // ヒットポイントを減らす
                hp = hp - bullet.power;

                // 弾の削除
                Destroy(c.gameObject);

                // ヒットポイントが0以下であれば
                if(hp <= 0 )
                {
                        // 爆発
                        spaceship.Explosion ();

                        // エネミーの削除
                        Destroy (gameObject);

                }else{

                        spaceship.GetAnimator().SetTrigger("Damage");

                }
        }
}
```

</div>

最後にEnemyゲームオブジェクトを削除して、ゲームを再生してみましょう。
弾が当たった時にエネミーが赤色になりました。ですが徐々に赤色になり、徐々に元の色に戻るアニメーション（フェード）になっています。
もう一度、アニメーターのTransitionのインスペクターを確認しましょう。
図11.7と図11.8のようにDummyステートからDamageステートへのTransitionのFadeのつまみを限りなく近づけてみましょう。

<div style="display:flex">

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/before_crossfade_1.png)
図11.7:

</div>

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/after_crossfade_1.png)
図11.8:

</div>

</div>

DamageステートからDummyステートへのTransitionも同じ設定を行います。ただし、**Exit
Timeを1**へ設定してください。

<div style="display:flex">

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/before_crossfade_2.png)
図11.9:

</div>

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/after_crossfade_2.png)
図11.10:

</div>

</div>

ゲームを再生してみてください。ダメージを受けた時、瞬間的に赤色になるはずです。

<span id="h11-3"></span>11.3　プレイヤーの無敵時間
--------------------------------------------------

ゲーム開始時にプレイヤーを点滅させ、無敵の状態を実装します。
実装方法はエネミーのダメージアニメーションの実装と同じです。

### <span id="h11-3-1"></span>レイヤーの追加

Playerアニメーターコントローラーを**ダブルクリック**してAnimrtorウィンドウを開きます。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/player_animator.png)

</div>

**Invincible
Layer**を追加します。**Weightを1**にするのを忘れないで下さい。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/add_invincible_layer.png)

</div>

### <span id="h11-3-2"></span>アニメーションの作成

Playerプレハブをシーン上へドラッグ＆ドロップしてください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/drop_player.png)

</div>

次にアニメーションのアセットを作成します。**Player**フォルダを選択し右クリックをして、`Create → Animation`{.inline-code}を選択しください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/create_animation_player.png)

</div>

作成されたアニメーションのアセット名は**Invincible**とします。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/create_invincible_animation.png)

</div>

**Invincible**アニメーションの**Loop Time**にチェックを入れてください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/check_invincible_loop.png)

</div>

**Invincible
Layer**に**Invincible**アニメーションをドラッグ＆ドロップし、**Invincible**ステートを作成します。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/drop_invincible_animation.png)

</div>

`Create State → Empty`{.inline-code}で**Dummy**ステートを作成し、**Invincible**ステートから**Dummy**ステートへのTransitionを作成します。
Transitionの**Exit
Timeは3**にしてください。これは3回**Invincible**アニメーションをループさせる処理になります。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/create_dummy_and_transition.png)

</div>

次にアニメーションを作成していきます。**Player**ゲームオブジェクトを選択しながらAnimationウィンドウを開き、**Invincible**アニメーションを選択してください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/select_invincible_animation.png)

</div>

`Add Curve`{.inline-code}ボタンで**Sprite Renderer → Enabled**と**Box
Collider 2D → Enabled**の２つを追加してください

<div style="display:flex">

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/add_sprite_renderer_enable_player.png)
図11.11:

</div>

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/add_boxcolider2d_enable_player.png)
図11.12:

</div>

</div>

0フレーム目はオフに、60フレーム目はオンにします。ただし、**Box Collider
2Dのキーは削除**してください。**Invincible**アニメーション再生中にコライダーを無効化し、当たり判定を発生させないことで無敵を実現させます。

<div style="display:flex">

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/invincible_0_frame.png)
図11.13:

</div>

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/invincible_60_frame.png)
図11.14:

</div>

</div>

これを交互に60フレームまで「オフ、オン、オフ、オン...」というようにキーを打ち込んでください。この作業を楽にする方法として、キーのコピー＆ペーストがあります。キーを選択し`⌘(Ctrl)+C`{.inline-code}でコピーしたら**0:10**の文字があるところをマウスでクリックし`⌘(Ctrl)+V`{.inline-code}でペーストしてください。

<div class="image">

![](wp-content/uploads/2d-shooting-game/game/images/11/invincible_0_60_frame.png)

</div>

最後に**Player**ゲームオブジェクトを削除して、ゲームを再生してみてください。ゲームを開始すると点滅の無敵状態が３秒間続きます。

### 第11回終わり

今回はここで終了です。つまずいてしまった方はプロジェクトファイルをダウンロードして新たな気持ちで次の回へ進みましょう。

[今回のプロジェクトファイルをダウンロード](./project/game_11_ShootingGame.zip)
